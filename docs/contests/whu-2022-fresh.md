## 2021武汉大学新生赛

!!!note "[I 异度之刃](https://ac.nowcoder.com/acm/contest/31620/I)"

    长为 $n$ 的序列 $a$，有 $m$ 组询问。每次查询区间 $[l,r]$ 中，有多少个「本质不同」的「连续上升」的子串。

    $n,m\leq 10^6$

注意到多组查询且无修改，考虑将查询按照右端点排序后，离线操作。

由于右端点不断向右移动，因此对于本质相同的子串，我们只需要保存最右侧的即可。

记 $f[i]$ 为左端点为 $i$ 的连续上升的子串个数（本质相同的子串只在最右侧的左端点处被统计），则每次查询的答案为 $\sum\limits_{i=l}^{r}{f[i]}$。

移动右端点 $r$，记 $[l,r]$ 是以 $r$ 为右端点且最长的「连续上升」子串，则由于 $r$ 的加入，区间 $f[l\sim r]$ 都增加 $1$。

下面考虑消除左侧「本质相同」的子串的影响，显然这些「本质相同」的子串的末尾元素与 $a[r]$ 相同。

对于每个值开一个单调栈，记录三个值：

- 它的位置 $rp$
- 以 $rp$ 为右端点的最长「连续上升」子串的左端点 $la$
- 当前「连续上升」子串的右端点 $ra$

注意到 $[la,rp]$ 是最长「连续」上升子串，而 $[la,r]$ 是它的一个前缀。

栈是单调的，自底向上 $rp-la+1$ （即最大子串长度）依次递减。

单调递减的原因在于，如果右侧出现一个长度更大的「连续子串」，则靠左的那些子串都会被删去（本质相同且更靠左）。只有当更左侧的子串长度更大时，它比右侧子串长的那部分才会被保留（长度小于等于右侧的部分被删除），这也就是第三个变量 $ra$ 的意义。

对于当前子串 $[l,r,r]$，对于当前栈顶 $[la,ra,rp]$，若 $rp-la\leq r-l$ ，则弹出栈顶，同时 $f[la\sim ra]$ 减一。

否则，考虑删去 $[la,ra,rp]$ 中长度不超过 $r-l+1$ 的部分，即 $[rp-(r-l),rp]$。但由于它此前部分后缀已经被删除，因此实际是 $f[rp-(r-l)\sim ra]$ 减一，并更新 $ra$ 为 $rp-(r-l+1)$ 。

$ra$ 实际上就是当前子串中，未被删除的实际右端点。

最后将 $[l,r,r]$ 插入栈顶。

区间加法和求和用线段树维护。

复杂度 $O((n+m)\log{n})$。

